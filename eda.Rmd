---
title: "Music & Mental Health - Exploratory Data Analysis"
author: "Jan Moskal"
date: "2025-05-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
```

### Wczytanie danych i wstępny wgląd w te dane

```{r}
data <- readRDS("df_EDA.rds")
df <- readRDS("df.rds")

head(data)
```

```{r}
glimpse(data)
```

```{r}
df_freq <- data %>% 
            select(`Frequency [Classical]`:Depression)
```

### Wizualizacja liczby obserwacji dla (Frequency + Genre)

```{r}
long_freq_count <- data %>%
                    pivot_longer(cols = starts_with("Frequency ["),
                                 names_to = "Genre",
                                 values_to = "Frequency") %>%
                    mutate(Genre = str_remove_all(Genre, "Frequency \\[|\\]"))  

heat_df_count <- long_freq_count %>%
                  count(Genre, Frequency)

ggplot(heat_df_count, aes(x = Genre, y = Frequency, fill = n)) +
  geom_tile(color = "white") +
  geom_text(aes(label = n), color = "black", size = 3) +
  scale_fill_gradient(low = "lightyellow", high = "steelblue") +
  theme_minimal() +
  labs(
    title = "Liczba obserwacji dla kombinacji gatunku vs częstotliwości słuchania",
    x = "Gatunek muzyki",
    y = "Częstotliwość słuchania",
    fill = "Liczba"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

### Wizualizacja zmiennych (Frequency vs Genre) vs Depression

```{r, warning=FALSE}
df_freq_depr <- df_freq %>%
                  mutate(Depression_num = recode(Depression,
                                                 "Low" = 0,
                                                 "Medium" = 1,
                                                 "High" = 2))

freq_cols <- grep("^Frequency \\[", names(data), value = TRUE)

df_long_depr <- df_freq_depr %>%
                  select(all_of(c("Depression_num", freq_cols))) %>%
                  pivot_longer(cols = all_of(freq_cols),
                               names_to = "Genre",
                               values_to = "Frequency")

heat_df_depr <- df_long_depr %>%
                  group_by(Genre, Frequency) %>%
                  summarise(mean_depression = mean(Depression_num, na.rm = TRUE)) %>%
                  ungroup()

heat_df_depr <- heat_df_depr %>%
                  mutate(Genre_clean = gsub("Frequency \\[|\\]", "", Genre))

ggplot(heat_df_depr, aes(x = Genre_clean, y = Frequency, fill = mean_depression)) +
  geom_tile(color = "white") +
  geom_text(aes(label = round(mean_depression, 2)), size = 3, color = "black") +
  scale_fill_gradient(low = "lightblue", high = "darkred", na.value = "grey80") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid = element_blank()) +
  labs(
    title = "Średni poziom depresji vs słuchalność gatunków muzyki",
    x = "Gatunek muzyki",
    y = "Poziom słuchalności",
    fill = "Średni poziom depresji"
  )
```

### Wizualizacja korelacji Spearmana częstotliwości słuchania gatunku z poziomem depresji

```{r}
df_freq_depr <- data %>%
                  mutate(Depression = recode(Depression,
                                                 "Low" = 0,
                                                 "Medium" = 1,
                                                 "High" = 2))
long_freq <- df_freq_depr %>%
  pivot_longer(
    cols = starts_with("Frequency ["),
    names_to = "Genre",
    values_to = "Frequency"
  ) %>%
  mutate(
    Genre = str_remove_all(Genre, "Frequency \\[|\\]"),
    Depression = as.numeric(Depression)
  )

freq_levels <- c("Never", "Rarely", "Sometimes", "Very frequently")
long_freq$Frequency <- factor(long_freq$Frequency, levels = freq_levels, ordered = TRUE)
long_freq$Frequency_num <- as.numeric(long_freq$Frequency)

correlations <- long_freq %>%
  group_by(Genre) %>%
  summarise(
    cor = cor(Frequency_num, Depression, method = "spearman"),
    n = n(),
    .groups = "drop"
  ) %>%
  arrange(cor)

ggplot(correlations, aes(x = reorder(Genre, cor), y = cor)) +
  geom_col(fill = ifelse(correlations$cor > 0, "firebrick", "steelblue")) +
  geom_text(aes(label = round(cor, 2)), vjust = ifelse(correlations$cor > 0, -0.5, 1.5), color = "black") +
  theme_minimal() +
  ylim(-0.05, 0.2) +
  labs(
    title = "Korelacja Spearmana częstotliwości słuchania gatunku z poziomem depresji",
    x = "Gatunek muzyczny",
    y = "Korelacja Spearmana"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Wizualizacja zmiennych Frequency vs Depression

```{r}
long_df_depr <- df_freq_depr %>%
                  select(starts_with("Frequency"), Depression) %>%
                  pivot_longer(
                    cols = starts_with("Frequency"),
                    names_to = "Genre",
                    values_to = "Frequency"
                  ) %>%
                  mutate(
                    Depression = case_when(
                      Depression == "Low" ~ 0,
                      Depression == "Medium" ~ 1,
                      Depression == "High" ~ 2
                    )
                  )

freq_df_depr <- long_df_depr %>%
                  group_by(Frequency) %>%
                  summarise(mean_depression = mean(Depression, na.rm = TRUE), .groups = "drop")

ggplot(freq_df_depr, aes(x = Frequency, y = mean_depression, fill = Frequency)) +
  geom_col(width = 0.6) +
  geom_text(aes(label = round(mean_depression, 2)), vjust = -0.5, size = 4) +
  scale_fill_brewer(palette = "Blues", direction = 1) +
  ylim(0, 2) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    title = "Średni poziom depresji vs częstotliwość słuchania muzyki",
    x = "Częstotliwość słuchania",
    y = "Średni poziom depresji"
  )
```

### Wizualizacja zmiennych (Frequency + Genre) vs Hours per day

```{r}
df_hours <- data %>% 
              select(`Frequency [Classical]`:`Frequency [Video game music]`, `Hours per day`)

freq_cols <- grep("^Frequency \\[", names(data), value = TRUE)

df_long_hours <- df_hours %>%
            select(all_of(c("Hours per day", freq_cols))) %>%
            pivot_longer(cols = all_of(freq_cols),
                         names_to = "Genre",
                         values_to = "Frequency")

heat_df_hours <- df_long_hours %>%
                  group_by(Genre, Frequency) %>%
                  summarise(mean_hours_per_day = mean(`Hours per day`, na.rm = TRUE)) %>%
                  ungroup()

heat_df_hours <- heat_df_hours %>%
                  mutate(Genre_clean = gsub("Frequency \\[|\\]", "", Genre))

ggplot(heat_df_hours, aes(x = Genre_clean, y = Frequency, fill = mean_hours_per_day)) +
  geom_tile(color = "white") +
  geom_text(aes(label = round(mean_hours_per_day, 2)), size = 3, color = "black") +
  scale_fill_gradient(low = "lightblue", high = "darkred", na.value = "grey80") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid = element_blank()) +
  labs(
    title = "Średni liczba przesłuchanych godzin vs słuchalność gatunków muzyki",
    x = "Gatunek muzyki",
    y = "Poziom słuchalności",
    fill = "Średnia liczba godzin"
  )
```

### Wizualizacje Frequency vs Hours per day

```{r}
long_df_hours <- df_hours %>%
            select(starts_with("Frequency"), `Hours per day`) %>%
            pivot_longer(
              cols = starts_with("Frequency"),
              names_to = "Genre",
              values_to = "Frequency"
            )

freq_df_hours <- long_df_hours %>%
            group_by(Frequency) %>%
            summarise(mean_hours_per_day = mean(`Hours per day`, na.rm = TRUE), .groups = "drop")

ggplot(freq_df_hours, aes(x = Frequency, y = mean_hours_per_day, fill = Frequency)) +
  geom_col(width = 0.6) +
  geom_text(aes(label = round(mean_hours_per_day, 2)), vjust = -0.5, size = 4) +
  scale_fill_brewer(palette = "Blues", direction = 1) +
  ylim(0, 5) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    title = "Średni liczba przesłuchanych godzin vs częstotliwość słuchania muzyki",
    x = "Częstotliwość słuchania",
    y = "Średnia liczba godzin"
  )
```

### Wizualizacja zmiennych (Frequency + Genre) vs Age

```{r}
df_age <- df %>% 
              select(`Frequency [Classical]`:`Frequency [Video game music]`, Age)

freq_cols <- grep("^Frequency \\[", names(data), value = TRUE)

df_long_age <- df_age %>%
                select(all_of(c("Age", freq_cols))) %>%
                pivot_longer(cols = all_of(freq_cols),
                             names_to = "Genre",
                             values_to = "Frequency")

heat_df_age <- df_long_age %>%
                  group_by(Genre, Frequency) %>%
                  summarise(mean_age = mean(Age, na.rm = TRUE)) %>%
                  ungroup()

heat_df_age <- heat_df_age %>%
                  mutate(Genre_clean = gsub("Frequency \\[|\\]", "", Genre))

ggplot(heat_df_age, aes(x = Genre_clean, y = Frequency, fill = mean_age)) +
  geom_tile(color = "white") +
  geom_text(aes(label = round(mean_age, 1)), size = 3, color = "black") +
  scale_fill_gradient(low = "lightblue", high = "darkred", na.value = "grey80") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid = element_blank()) +
  labs(
    title = "Średni wiek słuchającego vs słuchalność gatunków muzyki",
    x = "Gatunek muzyki",
    y = "Poziom słuchalności",
    fill = "Średnia wiek"
  )
```

### Wizualizacja zmiennych (Frequency + Genre) vs Fav genre
```{r}
long_freq <- data %>%
  pivot_longer(cols = starts_with("Frequency ["),
               names_to = "Genre",
               values_to = "Frequency") %>%
  mutate(Genre = str_remove_all(Genre, "Frequency \\[|\\]"))

long_freq_labeled <- long_freq %>%
                      mutate(is_fav = ifelse(Genre == `Fav genre`, 1, 0))

summary_df <- long_freq_labeled %>%
  group_by(Genre, Frequency) %>%
  summarise(
    total = n(),
    fav_count = sum(is_fav, na.rm = TRUE),
    .groups = "drop"
  )

ggplot(summary_df, aes(x = Genre, y = Frequency, fill = total)) +
  geom_tile(color = "white") +
  geom_text(aes(label = fav_count), color = "black", size = 3) +
  scale_fill_gradient(low = "lightyellow", high = "darkblue") +
  theme_minimal() +
  labs(
    title = "Ulubiony gatunek w kontekście częstotliwości słuchania",
    x = "Gatunek",
    y = "Częstotliwość słuchania",
    fill = "Liczba ogółem"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Związek między [...] a częstotliwością słuchaniem różnych gatunków muzyki
```{r}
# Lista zmiennych binarnych do analizy
binary_vars <- c("Instrumentalist", "While working", "Composer", "Exploratory", "Foreign languages")

# Przekształcenie danych do formatu długiego
long_bin_all <- data %>%
  select(all_of(freq_cols), all_of(binary_vars)) %>%
  pivot_longer(cols = all_of(freq_cols), names_to = "Genre", values_to = "Frequency") %>%
  mutate(Genre = str_remove_all(Genre, "Frequency \\[|\\]"))

# Funkcja do rysowania heatmapy dla danej zmiennej binarnej
plot_binary_heatmap <- function(df, bin_var) {
  df %>%
    mutate(!!bin_var := as.character(.data[[bin_var]])) %>%
    group_by(Genre, Frequency) %>%
    summarise(
      Count = sum(.data[[bin_var]] == "Yes", na.rm = TRUE),
      Total = n(),
      Prop = Count / Total,
      .groups = "drop"
    ) %>%
    ggplot(aes(x = Genre, y = Frequency, fill = Prop)) +
      geom_tile(color = "white") +
      geom_text(aes(label = Count), color = "black", size = 3) +
      scale_fill_gradient(low = "lightblue", high = "darkblue", na.value = "grey80") +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
      labs(
        title = paste0(bin_var, " vs słuchalność gatunków"),
        x = "Gatunek muzyki",
        y = "Częstotliwość słuchania",
        fill = "Proporcja"
      )
}

for (var in binary_vars) {
  print(plot_binary_heatmap(long_bin_all, var))
}
```


