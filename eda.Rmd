---
title: "Music & Mental Health Exploratory Data Analysis"
author: "Jan Moskal"
date: "2025-05-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(kableExtra)
```

```{r}
heatmap_plot <- function(df, title, fill_label){
  ggplot(df, aes(x = Genre, y = Frequency, fill = mean_val)) +
    geom_tile(color = "white") +
    geom_text(
      aes(label = round(mean_val, 2)),
          size = 3,
          color = "black") +
    scale_fill_gradient(low = "lightblue",
                        high = "darkred",
                        na.value = "grey80") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          panel.grid = element_blank()) +
    labs(title = title, x = "Gatunek", y = "Częstotliwość", fill = fill_label)
}

plot_mean_heatmap <- function(df, variable, title, fill){
  df %>% 
    pivot_longer(
      cols = all_of(freq_cols),
      names_to = "Genre",
      values_to = "Frequency"
    ) %>% 
    mutate(Genre = str_remove_all(Genre, "Frequency \\[|\\]")) %>% 
    group_by(Genre, Frequency) %>% 
    summarise(mean_val = mean(.data[[variable]], na.rm = TRUE),
              .groups = "drop"
    ) %>% 
    heatmap_plot(title = title, fill_label = fill)
}

plot_binary_heatmap <- function(df, bin_var) {
  df %>%
    group_by(Genre, Frequency) %>%
    summarise(
      Count = sum(.data[[bin_var]] == "Yes", na.rm = TRUE),
      Total = n(),
      Prop = Count / Total,
      .groups = "drop"
    ) %>%
    ggplot(aes(x = Genre, y = Frequency, fill = Prop)) +
    geom_tile(color = "white") +
    geom_text(aes(label = Count), color = "black", size = 3) +
    scale_fill_gradient(low = "lightblue", high = "darkblue") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(title = paste0(bin_var, " vs słuchalność"),
         x = "Gatunek",
         y = "Częstotliwość",
         fill = "Proporcja")
}
```



### Wczytanie danych i wstępny wgląd
```{r}
data <- readRDS("df_EDA.rds")
df <- readRDS("df.rds")

head(data)
glimpse(data)
```

### Przygotowanie danych
```{r}
freq_cols <- grep("^Frequency \\[", names(data), value = TRUE)
freq_levels <- c("Never", "Rarely", "Sometimes", "Very frequently")
binary_vars <- c("Instrumentalist", "While working", "Composer", "Exploratory", "Foreign languages")

long_freq <- data %>%
  pivot_longer(
   cols = all_of(freq_cols),
   names_to = "Genre",
   values_to = "Frequency"
  ) %>%
  mutate(
    Genre = str_remove_all(Genre, "^Frequency \\[|\\]$"),
    Frequency = factor(Frequency, levels = freq_levels, ordered = TRUE)
  )

df_depr <- data %>% 
            mutate(Depression = recode(Depression,
                                       "Low"= 0,
                                       "Medium" = 1,
                                       "High" = 2))

long_freq_depr <- long_freq %>% 
                    mutate(Depression = recode(Depression,
                                               "Low"= 0,
                                               "Medium" = 1,
                                               "High" = 2),
                           Frequency_num = as.numeric(Frequency)
                    )

long_bin_all <- data %>%
  select(all_of(freq_cols), all_of(binary_vars)) %>%
  pivot_longer(cols = all_of(freq_cols),
               names_to = "Genre",
               values_to = "Frequency") %>%
  mutate(Genre = str_remove_all(Genre, "Frequency \\[|\\]"))
```

### Heatmapa: Liczba obserwacji (Frequency vs Genre)
```{r}
long_freq %>% 
  count(Genre, Frequency) %>% 
  ggplot(aes(x = Genre, y = Frequency, fill = n)) +
  geom_tile(color = "white") +
  geom_text(aes(label = n), color = "black", size = 3) + 
  scale_fill_gradient(low = "lightyellow", high = "steelblue") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Liczba obserwacji: Gatunek vs Częstotliwość", 
       x = "Gatunek",
       y = "Częstotliwość słuchania", 
       fill = "Liczba obserwacji")
```

### Heatmapa: Średni poziom depresji (Frequency vs Genre)
```{r}
df_depr %>% 
  pivot_longer(
     cols = all_of(freq_cols),
     names_to = "Genre",
     values_to = "Frequency"
    ) %>% 
  mutate(
    Genre = str_remove_all(Genre, "Frequency \\[|\\]"),
    Frequency = factor(Frequency, levels = freq_levels, ordered = TRUE)
  ) %>% 
  group_by(Genre, Frequency) %>% 
  summarise(mean_val = mean(Depression, na.rm = TRUE), .groups = "drop") %>% 
  ggplot(aes(x = Genre, y = Frequency, fill = mean_val)) +
  geom_tile(color = "white") + 
  geom_text(aes(label = round(mean_val, 2)), size = 3, color = "black") +
  scale_fill_gradient(low = "lightblue", high = "darkred") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1), panel.grid = element_blank()) +
  labs(title = "Średni poziom depresji: Gatunek vs Częstotliwość",
       x = "Gatunek", 
       y = "Częstotliwość słuchania", 
       fill = "Średni poziom depresji")
```

### Korelacja Spearmana: Częstotliwość vs Depresja
```{r}
long_freq_depr %>% 
  group_by(Genre) %>% 
  summarise(
    cor = cor(Frequency_num, Depression, method = "spearman"),
    .groups = "drop"
  ) %>% 
  mutate(
    color = ifelse(cor > 0, "firebrick", "steelblue"),
    vjust_pos = ifelse(cor > 0, -0.5, 1.5)
  ) %>% 
  arrange(cor) %>% 
  ggplot(aes(x = reorder(Genre, cor), y = cor, fill = color)) + 
  geom_col() +
  geom_text(aes(label = round(cor, 2), vjust = vjust_pos),
            color = "black") + 
  scale_fill_identity() + 
  ylim(-0.05, 0.2) + 
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(
    title = "Korelacja Spearmana: Częstotliwość vs Depresja",
    x = "Gatunek",
    y = "Korelacja"
  )
```

### Średni poziom depresji dla każdej częstotliwości (Częstotliwość vs Depresja)
```{r}
long_freq_depr %>% 
  group_by(Frequency) %>% 
  summarise(mean_val = mean(Depression, na.rm = TRUE)) %>% 
  ggplot(aes(x = Frequency, y = mean_val, fill = Frequency)) +
  geom_col(width = 0.6) +
  geom_text(aes(label = round(mean_val, 2)), vjust = -0.5, size = 4) +
  scale_fill_brewer(palette = "Blues") +
  ylim(0, 2) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Średni poziom depresji dla każdej częstotliwości",
       x = "Częstotliwość",
       y = "Średnia poziom depresji")
```

### Heatmapa: Średnia liczba przesłuchanych godzin (Częstotliwość vs Gatunek)
```{r}
plot_mean_heatmap(data,
                  "Hours per day",
                  "Średnia liczba przesłuchanych godzin (Częstotliwość vs Gatunek)",
                  "Liczba godzin")
```

### Heatmapa: Średni wiek słuchającego (Częstotliwość vs Gatunek)
```{r}
plot_mean_heatmap(df,
                  "Age",
                  "Średni wiek (Częstotliwość vs Gatunek)",
                  "Wiek")
```

### Ulubiony gatunek muzyczny
```{r}
long_freq %>% 
  mutate(is_fav = ifelse(Genre == `Fav genre`, 1, 0)) %>% 
  group_by(Genre, Frequency) %>% 
  summarise(total = n(),
            fav_count = sum(is_fav, na.rm = TRUE), 
            prop = fav_count / total,
            .groups = "drop") %>% 
  ggplot(aes(x = Genre, y = Frequency, fill = prop)) + 
  geom_tile(color = "white") + 
  geom_text(aes(label = fav_count), color = "black", size = 3) + 
  scale_fill_gradient(low = "lightyellow", high = "darkblue") + 
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  labs(title = "Ulubiony gatunek muzyczny",
       x = "Gatunek",
       y = "Częstotliwość słuchania",
       fill = "Proporcja")
```

### Czy jesteś muzykiem
```{r}
plot_binary_heatmap(long_bin_all, "Instrumentalist") +
  labs(title = "Czy jesteś muzykiem",
       y = "Częstotliwosć słuchania")
```

### Czy jesteś kompozytorem 
```{r}
plot_binary_heatmap(long_bin_all, "Composer") +
  labs(title = "Czy jesteś kompozytorem",
       y = "Częstotliwość słuchania")
```

### Czy słuchasz muzyki w czasie pracy/nauki
```{r}
plot_binary_heatmap(long_bin_all, "While working") +
  labs(title = "Czy słuchasz muzyki w czasie pracy/nauki",
       y = "Częstotliwość słuchania")
```

### Czy aktywnie eksplorujesz nowych artystów/gatunki (Częstotliwość vs Gatunek)
```{r}
plot_binary_heatmap(long_bin_all, "Exploratory") +
  labs(title = "Czy aktywnie eksplorujesz nowych artystów/gatunki",
       y = "Częstotliwość słuchania")
```

### Czy regularnie słuchasz muzyki w języku dla ciebie obcym?
```{r}
plot_binary_heatmap(long_bin_all, "Foreign languages") +
  labs(title = "Czy regularnie słuchasz muzyki w języku dla ciebie obcym",
       y = "Częstotliwość słuchania")
```

